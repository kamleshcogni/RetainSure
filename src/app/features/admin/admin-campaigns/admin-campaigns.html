<app-sidebar></app-sidebar>

<div class="page-content bg-light min-vh-100">
  <div class="container-fluid px-0">

    <!-- Header -->
    <header class="mb-3 mb-md-4">
      <h2 class="fw-semibold text-dark mb-0 fs-5">Campaigns</h2>
    </header>

    <!-- BAND A: Overview -->
    <section class="card shadow-sm border-0 rounded-3 mb-3">
      <div class="card-body p-2 p-sm-3 p-md-4">
        <h3 class="fw-semibold text-dark fs-6 mb-3">Overview</h3>
        <div class="row g-2 g-md-3">
          <div class="col-12 col-sm-4">
            <div class="border rounded-3 p-2 p-md-3 bg-white text-center">
              <div class="text-muted small">Active Campaigns</div>
              <div class="fw-bold fs-4">{{ metrics?.activeCampaigns }}</div>
              <div class="text-success small">+1 this month</div>
            </div>
          </div>
          <div class="col-12 col-sm-4">
            <div class="border rounded-3 p-2 p-md-3 bg-white text-center">
              <div class="text-muted small">Avg. Conversion Rate</div>
              <div class="fw-bold fs-4">{{ metrics?.avgConversionRate }}%</div>
              <div class="text-success small">+2.1% vs last month</div>
            </div>
          </div>
          <div class="col-12 col-sm-4">
            <div class="border rounded-3 p-2 p-md-3 bg-white text-center">
              <div class="text-muted small">Avg. ROI</div>
              <div class="fw-bold fs-4">{{ metrics?.avgROI }}%</div>
              <div class="text-muted small">Stable</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- BAND B: Create / Edit Campaign -->
    <section class="card shadow-sm border-0 rounded-3 mb-3">
      <div class="card-body p-2 p-sm-3 p-md-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h3 class="fw-semibold text-dark fs-6 mb-0">
            {{ isEditing() ? 'Edit Campaign' : 'Create New Campaign' }}
          </h3>
          <span class="badge bg-primary-subtle text-primary small" *ngIf="isEditing()">
            Editing: {{ campaigns[editingIndex!]?.campaign_code }}
          </span>
        </div>

        <form [formGroup]="form" novalidate>
          <div class="row g-2 g-md-3">
            <div class="col-12">
              <label class="form-label text-secondary small mb-1">Campaign Name</label>
              <input
                class="form-control form-control-sm"
                type="text"
                formControlName="name"
                placeholder="e.g., Q4 Customer Appreciation"
              />
              <div class="text-danger small mt-1" *ngIf="form.controls['name'].touched && form.controls['name'].invalid">
                Name is required (min 3 characters)
              </div>
            </div>

            <div class="col-12">
              <label class="form-label text-secondary small mb-1">Discount</label>
              <input
                class="form-control form-control-sm"
                type="text"
                formControlName="offerDetails"
                placeholder="10% Discount on Renewal"
              />
            </div>

            <div class="col-6 col-md-4">
              <label class="form-label text-secondary small mb-1">Target Segment</label>
              <select class="form-select form-select-sm" formControlName="targetSegment">
                <option *ngFor="let s of segments" [value]="s">{{ s }}</option>
              </select>
            </div>

            <div class="col-6 col-md-4">
              <label class="form-label text-secondary small mb-1">Start Date</label>
              <input class="form-control form-control-sm" type="date" formControlName="startDate" />
            </div>

            <div class="col-6 col-md-4">
              <label class="form-label text-secondary small mb-1">End Date</label>
              <input class="form-control form-control-sm" type="date" formControlName="endDate" />
            </div>

            <div class="col-6 col-md-4" *ngIf="isEditing()">
              <label class="form-label text-secondary small mb-1">Status</label>
              <select class="form-select form-select-sm" formControlName="status">
                <option value="ACTIVE">ACTIVE</option>
                <option value="SCHEDULED">SCHEDULED</option>
                <option value="COMPLETED">COMPLETED</option>
              </select>
            </div>
          </div>

          <div class="d-grid d-sm-flex gap-2 mt-3">
            <ng-container *ngIf="!isEditing(); else editActions">
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="saveDraft()">Save Draft</button>
              <button type="button" class="btn btn-primary btn-sm" (click)="launchCampaign()">Launch Campaign</button>
            </ng-container>
            <ng-template #editActions>
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelEdit()">Cancel</button>
              <button type="button" class="btn btn-primary btn-sm" (click)="saveUpdate()">Update</button>
            </ng-template>
          </div>
        </form>
      </div>
    </section>

    <!-- BAND C: Campaigns Table -->
    <section class="card shadow-sm border-0 rounded-3 mb-3 mb-md-4">
      <div class="card-body p-2 p-sm-3 p-md-4">
        <h3 class="fw-semibold text-dark fs-6 mb-3">Campaigns</h3>

        <!-- Desktop Table -->
        <div class="d-none d-md-block table-responsive">
          <table class="table table-hover table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="fw-semibold text-secondary text-nowrap">Campaign ID</th>
                <th class="fw-semibold text-secondary text-nowrap">Campaign Name</th>
                <th class="fw-semibold text-secondary text-nowrap">Status</th>
                <th class="fw-semibold text-secondary text-nowrap">Target</th>
                <th class="fw-semibold text-secondary text-nowrap">Discount</th>
                <th class="fw-semibold text-secondary text-nowrap">Start Date</th>
                <th class="fw-semibold text-secondary text-nowrap">End Date</th>
                <th class="fw-semibold text-secondary text-nowrap">Actions</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let c of campaigns; let i = index">
                <tr>
                  <td class="fw-semibold">{{ c.campaign_code }}</td>
                  <td class="fw-semibold">{{ c.campaign_name }}</td>
                  <td>
                    <span class="badge rounded-pill"
                      [ngClass]="{
                        'bg-success': c.status === 'ACTIVE',
                        'bg-warning text-dark': c.status === 'SCHEDULED',
                        'bg-primary': c.status === 'COMPLETED'
                      }">
                      {{ c.status }}
                    </span>
                  </td>
                  <td>{{ c.target }}</td>
                  <td>{{ c.discount }}</td>
                  <td class="text-nowrap">{{ c.start_date ? toInputDate(c.start_date) : '-' }}</td>
                  <td class="text-nowrap">{{ c.end_date ? toInputDate(c.end_date) : '-' }}</td>
                  <td class="text-nowrap">
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm me-1"
                      *ngIf="c.status !== 'COMPLETED'"
                      (click)="editCampaign(i)">
                      Edit
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      (click)="detailsbutton(i)">
                      {{ expandedIndex === i ? 'Hide' : 'Details' }}
                    </button>
                  </td>
                </tr>

                <!-- Desktop Details Row -->
                <tr *ngIf="expandedIndex === i">
                  <td colspan="8" class="p-0 border-0">
                    <div class="p-3 bg-light border-top">
                      <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="fw-semibold small">Details · {{ c.campaign_code }} — {{ c.campaign_name }}</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="detailsbutton(i)">Close</button>
                      </div>
                      <div class="row g-3">
                        <div class="col-md-4">
                          <div class="text-muted small">Status</div>
                          <span class="badge rounded-pill"
                            [ngClass]="{
                              'bg-success': c.status === 'ACTIVE',
                              'bg-warning text-dark': c.status === 'SCHEDULED',
                              'bg-primary': c.status === 'COMPLETED'
                            }">
                            {{ c.status }}
                          </span>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Target Segment</div>
                          <div>{{ c.target }}</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Discount</div>
                          <div>{{ c.discount }}</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Start Date</div>
                          <div>{{ c.start_date ? toInputDate(c.start_date) : '-' }}</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">End Date</div>
                          <div>{{ c.end_date ? toInputDate(c.end_date) : '-' }}</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Created</div>
                          <div>{{ c.created_at ? toInputDate(c.created_at) : '-' }}</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Modified</div>
                          <div>{{ c.modified_at ? toInputDate(c.modified_at) : '-' }}</div>
                        </div>
                        <div class="col-md-4" *ngIf="c.segmentSize !== undefined">
                          <div class="text-muted small">Segment Size</div>
                          <div>{{ c.segmentSize }}</div>
                        </div>
                        <div class="col-md-4" *ngIf="c.conversions !== undefined">
                          <div class="text-muted small">Conversions</div>
                          <div>{{ c.conversions }}</div>
                        </div>
                        <div class="col-md-4" *ngIf="c.conversionRate !== undefined">
                          <div class="text-muted small">Conversion Rate</div>
                          <div>{{ c.conversionRate }}%</div>
                        </div>
                        <div class="col-md-4" *ngIf="c.roi !== undefined">
                          <div class="text-muted small">ROI</div>
                          <div>{{ c.roi }}%</div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div class="d-md-none">
          <div *ngFor="let c of campaigns; let i = index" class="border rounded-3 p-2 mb-2 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small">
                <span class="fw-semibold">{{ c.campaign_code }}</span>
                <span class="text-muted ms-1">· {{ c.campaign_name }}</span>
              </span>
              <span class="badge rounded-pill"
                [ngClass]="{
                  'bg-success': c.status === 'ACTIVE',
                  'bg-warning text-dark': c.status === 'SCHEDULED',
                  'bg-primary': c.status === 'COMPLETED'
                }">
                {{ c.status }}
              </span>
            </div>
            <div class="d-flex flex-wrap gap-2 small text-muted mb-1">
              <span>Target: {{ c.target }}</span>
              <span>· {{ c.discount }}</span>
            </div>
            <div class="d-flex flex-wrap gap-2 small text-muted mb-2">
              <span>{{ c.start_date ? toInputDate(c.start_date) : '-' }}</span>
              <span>→</span>
              <span>{{ c.end_date ? toInputDate(c.end_date) : '-' }}</span>
            </div>
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                *ngIf="c.status !== 'COMPLETED'"
                (click)="editCampaign(i)">
                Edit
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                (click)="detailsbutton(i)">
                {{ expandedIndex === i ? 'Hide' : 'Details' }}
              </button>
            </div>

            <!-- Mobile Details Expansion -->
            <div *ngIf="expandedIndex === i" class="mt-2 p-2 bg-light rounded-3 border-top">
              <div class="fw-semibold small mb-2">Details · {{ c.campaign_code }}</div>
              <div class="row g-2">
                <div class="col-6">
                  <div class="text-muted small">Status</div>
                  <span class="badge rounded-pill"
                    [ngClass]="{
                      'bg-success': c.status === 'ACTIVE',
                      'bg-warning text-dark': c.status === 'SCHEDULED',
                      'bg-primary': c.status === 'COMPLETED'
                    }">
                    {{ c.status }}
                  </span>
                </div>
                <div class="col-6">
                  <div class="text-muted small">Target</div>
                  <div class="small">{{ c.target }}</div>
                </div>
                <div class="col-6">
                  <div class="text-muted small">Discount</div>
                  <div class="small">{{ c.discount }}</div>
                </div>
                <div class="col-6">
                  <div class="text-muted small">Start Date</div>
                  <div class="small">{{ c.start_date ? toInputDate(c.start_date) : '-' }}</div>
                </div>
                <div class="col-6">
                  <div class="text-muted small">End Date</div>
                  <div class="small">{{ c.end_date ? toInputDate(c.end_date) : '-' }}</div>
                </div>
                <div class="col-6">
                  <div class="text-muted small">Created</div>
                  <div class="small">{{ c.created_at ? toInputDate(c.created_at) : '-' }}</div>
                </div>
                <div class="col-6">
                  <div class="text-muted small">Modified</div>
                  <div class="small">{{ c.modified_at ? toInputDate(c.modified_at) : '-' }}</div>
                </div>
                <div class="col-6" *ngIf="c.segmentSize !== undefined">
                  <div class="text-muted small">Segment Size</div>
                  <div class="small">{{ c.segmentSize }}</div>
                </div>
                <div class="col-6" *ngIf="c.conversions !== undefined">
                  <div class="text-muted small">Conversions</div>
                  <div class="small">{{ c.conversions }}</div>
                </div>
                <div class="col-6" *ngIf="c.conversionRate !== undefined">
                  <div class="text-muted small">Conversion Rate</div>
                  <div class="small">{{ c.conversionRate }}%</div>
                </div>
                <div class="col-6" *ngIf="c.roi !== undefined">
                  <div class="text-muted small">ROI</div>
                  <div class="small">{{ c.roi }}%</div>
                </div>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-sm mt-2 w-100" (click)="detailsbutton(i)">Close</button>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>
