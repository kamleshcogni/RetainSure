<app-sidebar></app-sidebar>

<div class="page-content bg-light min-vh-100">
  <div class="container-fluid px-0">

    <!-- Header -->
    <header class="mb-3 mb-md-4">
      <h2 class="fw-semibold text-dark mb-0 fs-5">Admin ‚Äì Reminders</h2>
    </header>

    <!-- Search -->
    <section class="card shadow-sm border-0 rounded-3 mb-3">
      <div class="card-body p-2 p-sm-3 p-md-4">
        <div class="row g-2 align-items-end">
          <div class="col-7 col-sm-5 col-md-4">
            <label class="form-label text-secondary small mb-1">Search By Customer ID</label>
            <input
              type="number"
              class="form-control form-control-sm"
              [(ngModel)]="custIdFilter"
              placeholder="üîé e.g. 4"
              min="1"
              (keyup.enter)="searchByCustomer()"
            />
          </div>
          <div class="col-5 col-sm-4 col-md-3">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-primary btn-sm" (click)="searchByCustomer()">Search</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="clearSearch()" *ngIf="isSearching">Clear</button>
            </div>
          </div>
        </div>
        <div class="mt-2" *ngIf="isSearching">
          <span class="badge bg-light text-dark border small">
            Customer: {{ searchedCustomerId }}
            <span class="ms-1 text-muted" style="cursor:pointer" (click)="clearSearch()">‚úï</span>
          </span>
          <span class="text-muted small ms-2">{{ allReminders.length }} found</span>
        </div>
      </div>
    </section>

    <!-- Reminders Table -->
    <section class="card shadow-sm border-0 rounded-3 mb-3 mb-md-4">
      <div class="card-body p-2 p-sm-3 p-md-4">

        <div *ngIf="!isLoading; else loading">
          <ng-container *ngIf="allReminders.length > 0; else noData">

            <!-- Desktop -->
            <div class="d-none d-md-block table-responsive">
              <table class="table table-hover table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="fw-semibold text-secondary text-nowrap">#</th>
                    <th class="fw-semibold text-secondary text-nowrap">Policy</th>
                    <th class="fw-semibold text-secondary text-nowrap">Customer</th>
                    <th class="fw-semibold text-secondary text-nowrap">Category</th>
                    <th class="fw-semibold text-secondary text-nowrap">Date</th>
                    <th class="fw-semibold text-secondary text-nowrap">Risk Score</th>
                    <th class="fw-semibold text-secondary text-nowrap">Status</th>
                    <th class="fw-semibold text-secondary">Message</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let r of pagedReminders; let i = index">
                    <td class="text-muted small">{{ (page - 1) * pageSize + i + 1 }}</td>
                    <td>{{ r.policy_id }}</td>
                    <td>{{ r.cust_id }}</td>
                    <td>
                      <span class="badge rounded-pill"
                        [ngClass]="{'bg-success': r.category === 'HEALTH', 'bg-primary': r.category === 'MOTOR', 'bg-secondary': !r.category}">
                        {{ r.category ?? 'N/A' }}
                      </span>
                    </td>
                    <td class="text-nowrap">{{ r.date_sent }}</td>
                    <td>
                      <span [class.text-danger]="(getRiskForCust(r.cust_id) ?? 0) >= bulkForm.riskThreshold"
                            [class.fw-bold]="(getRiskForCust(r.cust_id) ?? 0) >= bulkForm.riskThreshold">
                        {{ getRiskForCust(r.cust_id) ?? '-' }}
                      </span>
                    </td>
                    <td>
                      <span class="badge rounded-pill"
                        [ngClass]="{'bg-success': r.status === 'RESPONDED', 'bg-primary': r.status === 'SENT'}">
                        {{ r.status }}
                      </span>
                    </td>
                    <td class="text-break small">{{ r.trigger }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Mobile -->
            <div class="d-md-none">
              <div *ngFor="let r of pagedReminders; let i = index" class="border rounded-3 p-2 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="small">
                    <span class="text-muted">#{{ (page - 1) * pageSize + i + 1 }}</span>
                    <span class="fw-semibold ms-1">Policy {{ r.policy_id }}</span>
                    <span class="text-muted ms-1">¬∑ Cust {{ r.cust_id }}</span>
                  </span>
                  <span class="badge rounded-pill"
                    [ngClass]="{'bg-success': r.status === 'RESPONDED', 'bg-primary': r.status === 'SENT'}">
                    {{ r.status }}
                  </span>
                </div>
                <div class="d-flex flex-wrap gap-2 small text-muted">
                  <span class="badge rounded-pill"
                    [ngClass]="{'bg-success': r.category === 'HEALTH', 'bg-primary': r.category === 'MOTOR', 'bg-secondary': !r.category}">
                    {{ r.category ?? 'N/A' }}
                  </span>
                  <span>{{ r.date_sent }}</span>
                  <span>Risk: <span [class.text-danger]="(getRiskForCust(r.cust_id) ?? 0) >= bulkForm.riskThreshold" [class.fw-bold]="(getRiskForCust(r.cust_id) ?? 0) >= bulkForm.riskThreshold">{{ getRiskForCust(r.cust_id) ?? '-' }}</span></span>
                </div>
                <div class="small text-muted mt-1 text-break" *ngIf="r.trigger">{{ r.trigger }}</div>
              </div>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <button class="btn btn-outline-secondary btn-sm" (click)="prevPage()" [disabled]="page === 1">‚Üê Prev</button>
              <span class="text-muted small">{{ page }} / {{ maxPage }}</span>
              <button class="btn btn-outline-secondary btn-sm" (click)="nextPage()" [disabled]="page >= maxPage">Next ‚Üí</button>
            </div>

          </ng-container>

          <!-- No Data -->
          <ng-template #noData>
            <div class="text-center py-5">
              <div style="font-size:2.5rem" class="mb-2">{{ isSearching ? 'üîç' : 'üì≠' }}</div>
              <p class="fw-semibold text-muted mb-1">{{ isSearching ? 'No match found' : 'No reminders yet' }}</p>
              <p class="text-muted small mb-3">
                <span *ngIf="isSearching">No reminders found for Customer <strong>{{ searchedCustomerId }}</strong>.</span>
                <span *ngIf="!isSearching">Use the bulk form below to create reminders.</span>
              </p>
              <button class="btn btn-outline-primary btn-sm" *ngIf="isSearching" (click)="clearSearch()">Clear search</button>
            </div>
          </ng-template>
        </div>

        <ng-template #loading>
          <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="text-muted small ms-2">Loading‚Ä¶</span>
          </div>
        </ng-template>

      </div>
    </section>

    <!-- Bulk Create -->
    <section class="card shadow-sm border-0 rounded-3 mb-3">
      <div class="card-body p-2 p-sm-3 p-md-4">
        <h3 class="fw-semibold text-dark fs-6 mb-3">Bulk Create by Risk Score</h3>
        <div class="row g-2 g-md-3">
          <div class="col-6 col-md-4">
            <label class="form-label text-secondary small mb-1">Risk Threshold</label>
            <input type="number" class="form-control form-control-sm" min="0" max="100" [(ngModel)]="bulkForm.riskThreshold" />
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label text-secondary small mb-1">Category</label>
            <select class="form-select form-select-sm" [(ngModel)]="bulkForm.category">
              <option value="ANY">ANY</option>
              <option value="HEALTH">HEALTH</option>
              <option value="MOTOR">MOTOR</option>
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label text-secondary small mb-1">Date</label>
            <input type="text" class="form-control form-control-sm bg-light text-muted" [value]="todayISO()" disabled />
          </div>
          <div class="col-12">
            <label class="form-label text-secondary small mb-1">Message</label>
            <input type="text" class="form-control form-control-sm" [(ngModel)]="bulkForm.trigger" placeholder="Bulk reminder message..." />
          </div>
        </div>
        <div class="d-grid d-sm-block mt-3">
          <button class="btn btn-primary btn-sm" (click)="bulkCreateByRiskScore()" [disabled]="bulkCreating">
            <span *ngIf="bulkCreating" class="spinner-border spinner-border-sm me-1"></span>
            {{ bulkCreating ? 'Creating‚Ä¶' : 'Create Reminders' }}
          </button>
        </div>
      </div>
    </section>

  </div>
</div>